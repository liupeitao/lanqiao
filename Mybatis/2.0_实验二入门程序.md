#### å®éªŒä»‹ç»ğŸ˜¯

2022å¹´06æœˆ06æ—¥20:16:13

---

#### å®éªŒå†…å®¹

æœ¬æ¬¡è¯¾ç¨‹æˆ‘ä»¬å­¦ä¹ ä¸€ä¸ª MyBatis çš„å…¥é—¨å°ç¨‹åºï¼Œåˆ©ç”¨ MyBatis å®ç°æ•°æ®åº“æ•°æ®çš„å¢åˆ æ”¹æŸ¥æ“ä½œã€‚

#### å®éªŒçŸ¥è¯†ç‚¹

- MyBatis æ¡†æ¶
- æ¥å£å¼ç¼–ç¨‹
- MySQL

#### å®éªŒç¯å¢ƒ

- JDK1.8
- WEB IDE
- MySQL 5.7

#### ä»£ç è·å–

```bash
wget https://labfile.oss.aliyuncs.com/courses/802/MybatisTest.zip
```



#### é¡¹ç›®æ–‡ä»¶ç»“æ„



![æ­¤å¤„è¾“å…¥å›¾ç‰‡çš„æè¿°](images/document-uid441493labid8432timestamp1542090761913.jpeg)

æ¥ä¸‹æ¥å°±æ˜¯å®æˆ˜äº†

æœ¬æ¬¡è¯¾ç¨‹ä½¿ç”¨ MySQL æ•°æ®åº“ã€‚é¦–å…ˆå¯åŠ¨ mysql ï¼š

```bash
sudo service mysql start
```

ç„¶ååœ¨ç»ˆç«¯ä¸‹è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œè¿›å…¥åˆ° MySQL æ•°æ®åº“ï¼ˆ-u è¡¨ç¤ºç”¨æˆ·åï¼Œæ¯”å¦‚è¿™é‡Œçš„ rootï¼Œ-p è¡¨ç¤ºå¯†ç ï¼Œè¿™é‡Œæ²¡æœ‰å¯†ç å°±çœç•¥äº†ï¼‰ï¼š

```bash
mysql -u root
```

![æ­¤å¤„è¾“å…¥å›¾ç‰‡çš„æè¿°](images/document-uid441493labid8432timestamp1542077841028.jpeg)

ä¸ºäº†å®éªŒæ–¹ä¾¿ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œæ–°å»ºä¸€ä¸ªæ•°æ®åº“å¹¶å–å `mybatis` ç”¨ä½œå®éªŒã€‚

```sql
create database mybatis;
show databases;
```

![æ­¤å¤„è¾“å…¥å›¾ç‰‡çš„æè¿°](images/document-uid441493labid8432timestamp1542077901510.jpeg)

åˆ›å»ºè¡¨ `user` ï¼Œä»£ç å¦‚ä¸‹ï¼š

```sql
use mybatis;
create table user(
id int primary key auto_increment,
username varchar(20),
password varchar(20),
sex varchar(10),
address varchar(20));
```

![æ­¤å¤„è¾“å…¥å›¾ç‰‡çš„æè¿°](images/document-uid441493labid8432timestamp1542078002350.jpeg)



---

#### å¯¼å…¥æ‰€éœ€ jar åŒ…



æ‰“å¼€ pom.xml æ–‡ä»¶ï¼Œä¿®æ”¹ä¸ºä»¥ä¸‹å†…å®¹

```xml
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <groupId>com.shiyanlou.mybatis</groupId>
    <artifactId>MybatisTest</artifactId>
    <packaging>jar</packaging>
    <version>1.0-SNAPSHOT</version>
    <name>MybatisTest</name>
    <url>http://maven.apache.org</url>
    <dependencies>
        <dependency>
            <groupId>org.mybatis</groupId>
            <artifactId>mybatis</artifactId>
            <version>3.4.6</version>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>6.0.6</version>
        </dependency>
        <dependency>
            <groupId>log4j</groupId>
            <artifactId>log4j</artifactId>
            <version>1.2.17</version>
        </dependency>

    </dependencies>

    <build>
        <resources>
            <resource>
                <directory>src/main/java</directory>
                <includes>
                    <include>**/*.xml</include>
                </includes>
            </resource>
            <resource>
                <directory>src/main/resources</directory>
                <includes>
                    <include>**/*.*</include>
                </includes>
            </resource>
        </resources>
    </build>
</project>
```

---

#### é…ç½®æ–‡ä»¶ mybatis.cfg.xml



åœ¨é¡¹ç›®ç›®å½• `src/main/` ä¸‹æ–°å»ºæ–‡ä»¶å¤¹`resources`ï¼Œæ¥ç€åœ¨`resources`ä¸‹æ–°å»º MyBatis é…ç½®æ–‡ä»¶ `mybatis.cfg.xml` ï¼Œç”¨æ¥é…ç½® Mybatis çš„è¿è¡Œç¯å¢ƒã€æ•°æ®æºã€äº‹åŠ¡ç­‰ã€‚

mybatis.cfg.xml çš„é…ç½®å¦‚ä¸‹ï¼Œå…·ä½“è§£é‡Šæ³¨é‡Šå·²ç»ç»™å‡ºï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
       <!-- é…ç½® mybatis è¿è¡Œç¯å¢ƒ -->
    <environments default="development">
        <environment id="development">
           <!-- type="JDBC" ä»£è¡¨ç›´æ¥ä½¿ç”¨ JDBC çš„æäº¤å’Œå›æ»šè®¾ç½® -->
            <transactionManager type="JDBC" />

            <!-- POOLED è¡¨ç¤ºæ”¯æŒ JDBC æ•°æ®æºè¿æ¥æ±  -->
            <!-- æ•°æ®åº“è¿æ¥æ± ï¼Œç”± Mybatis ç®¡ç†ï¼Œæ•°æ®åº“åæ˜¯ mybatisï¼ŒMySQL ç”¨æˆ·å rootï¼Œå¯†ç ä¸ºç©º -->
            <dataSource type="POOLED">
                <property name="driver" value="com.mysql.jdbc.Driver" />
                <property name="url" value="jdbc:mysql://localhost:3306/mybatis" />
                <property name="username" value="root" />
                <property name="password" value="" />
            </dataSource>
        </environment>
    </environments>
</configuration>
```

---

#### å®ä½“ç±» User

åœ¨åŒ… `com.shiyanlou.mybatis.model` ä¸‹æ–°å»ºç±» User.java ï¼Œ ä¸€ä¸ªç”¨æˆ·å…·æœ‰ï¼šidã€usernameã€passwordã€sexã€address äº”ä¸ªå±æ€§ã€‚ä½œä¸º mybatis è¿›è¡Œ sql æ˜ å°„ä½¿ç”¨ï¼Œä¸æ•°æ®åº“è¡¨å¯¹åº”ã€‚

User ç±»çš„ä»£ç å¦‚ä¸‹ï¼š

```java
package com.shiyanlou.mybatis.model;

public class User {

    private Integer id;
    private String username;
    private String password;
    private String sex;
    private String address;

    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

    public String getSex() {
        return sex;
    }

    public void setSex(String sex) {
        this.sex = sex;
    }

    public String getAddress() {
        return address;
    }

    public void setAddress(String address) {
        this.address = address;
    }

}
```



---

æ–°å»ºåŒ… `com.shiyanlou.mybatis.mapper` ï¼Œå¹¶åœ¨åŒ…ä¸‹æ–°å»ºæ–¹æ³•æ¥å£ UserMapper.java ï¼Œæä¾›ç®€å•çš„å¢åˆ æ”¹æŸ¥æ•°æ®æ“ä½œã€‚

UserMapper æ¥å£çš„ä»£ç å¦‚ä¸‹ï¼š

```java
package com.shiyanlou.mybatis.mapper;

import java.util.List;

import com.shiyanlou.mybatis.model.User;

public interface UserMapper {

    /*
     * æ–°å¢ç”¨æˆ¶
     * @param user
     * @return
     * @throws Exception
     */
    public int insertUser(User user) throws Exception;

    /*
     * ä¿®æ”¹ç”¨æˆ¶
     * @param user
     * @param id
     * @return
     * @throws Exception
     */
    public int updateUser(User user) throws Exception;

    /*
     * åˆªé™¤ç”¨æˆ¶
     * @param id
     * @return
     * @throws Exception
     */
    public int deleteUser(Integer id) throws Exception;

    /*
     * æ ¹æ® id æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
     * @param id
     * @return
     * @throws Exception
     */
    public User selectUserById(Integer id) throws Exception;

    /*
     * æŸ¥è¯¢æ‰€æœ‰çš„ç”¨æˆ·ä¿¡æ¯
     * @return
     * @throws Exception
     */
    public List<User> selectAllUser() throws Exception;
}
```

åœ¨åŒ… `com.shiyanlou.mybatis.mapper` ä¸‹æ–°å»ºæ˜ å°„æ–‡ä»¶ `UserMapper.xml` ï¼Œç”¨æ¥å®šä¹‰å„ç§ SQL è¯­å¥å’Œè¿™äº›è¯­å¥çš„å‚æ•°ï¼Œä»¥åŠè¦è¿”å›çš„ç±»å‹ç­‰ã€‚

#### UserMapper.xml é…ç½®ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTD Mapper 3.0" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shiyanlou.mybatis.mapper.UserMapper">
    <!-- è‡ªå®šä¹‰è¿”å›ç»“æœé›† -->
    <resultMap id="userMap" type="User">
        <id property="id" column="id" javaType="int"></id>
        <result property="username" column="username" javaType="String"></result>
        <result property="password" column="password" javaType="String"></result>
        <result property="sex" column="sex" javaType="String"></result>
        <result property="address" column="address" javaType="String"></result>
    </resultMap>

    <!-- å®šä¹‰ SQL è¯­å¥ï¼Œå…¶ä¸­ id éœ€è¦å’Œæ¥å£ä¸­çš„æ–¹æ³•åä¸€è‡´ -->
    <!-- useGeneratedKeysï¼šå®ç°è‡ªåŠ¨ç”Ÿæˆä¸»é”® -->
    <!-- keyPropertyï¼š å”¯ä¸€æ ‡è®°ä¸€ä¸ªå±æ€§ -->
    <!-- parameterType æŒ‡æ˜æŸ¥è¯¢æ—¶ä½¿ç”¨çš„å‚æ•°ç±»å‹ï¼ŒresultType æŒ‡æ˜æŸ¥è¯¢è¿”å›çš„ç»“æœé›†ç±»å‹ -->
    <insert id="insertUser" useGeneratedKeys="true" keyProperty="id">
        insert into user (username,password,sex,address) values
        (#{username},#{password},#{sex},#{address})
    </insert>

    <update id="updateUser"  parameterType="User">
        update user set
        address=#{address} where
        id=#{id}
    </update>

    <delete id="deleteUser" parameterType="int">
        delete from user where
        id=#{id}
    </delete>

    <!-- å¦‚æœªä¸º Java Bean èµ·ç±»åˆ«åï¼ŒresultType="com.shiyanlou.mybatis.model.User" -->

    <!-- ä½¿ç”¨ resultType æ—¶ï¼Œä¸€å®šè¦ä¿è¯ï¼Œä½ å±æ€§åä¸å­—æ®µåç›¸åŒï¼›å¦‚æœä¸ç›¸åŒï¼Œå°±ä½¿ç”¨ resultMap -->
    <select id="selectUserById" parameterType="int" resultType="User">
        select * from user where id=#{id}
    </select>

    <select id="selectAllUser" resultMap="userMap">
        select * from user
    </select>

</mapper>
```

UserMapper.xml æ˜ å°„æ–‡ä»¶å†™å¥½åï¼Œéœ€è¦åœ¨ mybatis.cfg.xml ä¸­åŠ è½½å®ƒï¼Œåœ¨ mybatis.cfg.xml ä¸­æ·»åŠ ä»£ç ï¼š

```xml
<mappers>
    <!-- é€šè¿‡ mapper æ¥å£åŒ…åŠ è½½æ•´ä¸ªåŒ…çš„æ˜ å°„æ–‡ä»¶ -->
    <package name="com.shiyanlou.mybatis.mapper" />
</mappers>
```

åŒæ—¶ä¸º Java Bean èµ·åˆ«åï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç ï¼š

```xml
<!-- ä¸º JavaBean èµ·ç±»åˆ«å -->
<typeAliases>
    <!-- æŒ‡å®šä¸€ä¸ªåŒ…åèµ·åˆ«åï¼Œå°†åŒ…å†…çš„ Java ç±»çš„ç±»åä½œä¸ºç±»çš„ç±»åˆ«å -->
    <package name="com.shiyanlou.mybatis.model" />
</typeAliases>
```

æ³¨æ„é¡ºåºï¼štypeAliases -> environments -> mappers

![æ­¤å¤„è¾“å…¥å›¾ç‰‡çš„æè¿°](images/document-uid441493labid8432timestamp1542080079878.jpeg)

---

#### æµ‹è¯•ç±» UserTest

åœ¨åŒ… `com.shiyanlou.mybatis.test` ä¸‹æ–°å»ºæµ‹è¯•ç±» `UserTest.java` ï¼Œ ç”¨æ¥æµ‹è¯•æ•°æ®çš„å¢åˆ æ”¹æŸ¥æ“ä½œã€‚

UserTest ç±»çš„ä»£ç å¦‚ä¸‹ï¼š

```java
package com.shiyanlou.mybatis.test;

import java.io.IOException;
import java.io.InputStream;
import java.util.List;

import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;

import com.shiyanlou.mybatis.mapper.UserMapper;
import com.shiyanlou.mybatis.model.User;

public class UserTest {
    private static SqlSessionFactory sqlSessionFactory;

    public static void main(String[] args) {
        // Mybatis é…ç½®æ–‡ä»¶
        String resource = "mybatis.cfg.xml";

        // å¾—åˆ°é…ç½®æ–‡ä»¶æµ
        InputStream inputStream = null;
        try {
            inputStream = Resources.getResourceAsStream(resource);
        } catch (IOException e) {
            e.printStackTrace();
        }

        // åˆ›å»ºä¼šè¯å·¥å‚ï¼Œä¼ å…¥ MyBatis çš„é…ç½®æ–‡ä»¶ä¿¡æ¯
        sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);

        insertUser();
        // updateUser();
        // deleteUser();
        // selectUserById();
        // selectAllUser();

    }

    // æ–°å¢ç”¨æˆ¶
    private static void insertUser() {
        // é€šè¿‡å·¥å‚å¾—åˆ° SqlSession
        SqlSession session = sqlSessionFactory.openSession();

        UserMapper mapper = session.getMapper(UserMapper.class);
        User user = new User();
        user.setUsername("Tom");
        user.setPassword("123456");
        user.setSex("male");
        user.setAddress("chengdu");
        try {
            mapper.insertUser(user);

            session.commit();
        } catch (Exception e) {
            e.printStackTrace();
            session.rollback();
        }

        // é‡Šæ”¾èµ„æº
        session.close();
    }

    // æ›´æ–°ç”¨æˆ¶
    private static void updateUser() {

        SqlSession session = sqlSessionFactory.openSession();

        UserMapper mapper = session.getMapper(UserMapper.class);
        User user = null;
        try {
            user = mapper.selectUserById(1);
        } catch (Exception e1) {
            e1.printStackTrace();
        }
        user.setAddress("chongqing");
        try {
            mapper.updateUser(user);
            session.commit();
        } catch (Exception e) {
            e.printStackTrace();
            session.rollback();
        }

        session.close();
    }

    // åˆ é™¤ç”¨æˆ¶
    private static void deleteUser() {

        SqlSession session = sqlSessionFactory.openSession();

        UserMapper mapper = session.getMapper(UserMapper.class);
        try {
            mapper.deleteUser(3);
            session.commit();
        } catch (Exception e) {
            e.printStackTrace();
            session.rollback();
        }

        session.close();
    }

    // æ ¹æ® id æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
    private static void selectUserById() {

        SqlSession session = sqlSessionFactory.openSession();

        UserMapper mapper = session.getMapper(UserMapper.class);
        try {
            User user = mapper.selectUserById(1);
            session.commit();
            System.out.println(user.getId() + " " + user.getUsername() + " "
                    + user.getPassword() + " " + user.getSex() + " "
                    + user.getAddress());
        } catch (Exception e) {
            e.printStackTrace();
            session.rollback();
        }

        session.close();
    }

    // æŸ¥è¯¢æ‰€æœ‰çš„ç”¨æˆ·ä¿¡æ¯
    private static void selectAllUser() {

        SqlSession session = sqlSessionFactory.openSession();

        UserMapper mapper = session.getMapper(UserMapper.class);
        try {
            List<User> userList = mapper.selectAllUser();
            session.commit();
            for (User user : userList) {
                System.out.println(user.getId() + " " + user.getUsername() + " "
                        + user.getPassword() + " " + user.getSex() + " "
                        + user.getAddress());
            }
        } catch (Exception e) {
            e.printStackTrace();
            session.rollback();
        }
        session.close();
    }
}
```

#### å®éªŒæ€»ç»“



æœ¬æ¬¡å®éªŒå®Œæˆäº† Mybatis çš„ä¸€ä¸ªç®€å•çš„å…¥é—¨ç¨‹åºï¼Œç®€å•çš„å®ç°äº†å¯¹æ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥åŠŸèƒ½ï¼Œå¯¹ MyBatis æœ‰äº†ä¸€ä¸ªåŸºæœ¬çš„äº†è§£ã€‚

